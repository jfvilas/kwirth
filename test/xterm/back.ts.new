import express from "express";
import http from "http";
import WebSocket, { WebSocketServer } from "ws";
import { KubeConfig, Exec } from "@kubernetes/client-node";
import stream from "stream";

const app = express();
const server = http.createServer(app);
const wss = new WebSocketServer({ server });

const kc = new KubeConfig();
kc.loadFromDefault();
const exec = new Exec(kc);

wss.on("connection", async (ws, req) => {
  const url = new URL(req.url || "", `http://${req.headers.host}`);
  const pod = url.searchParams.get("pod");
  const namespace = url.searchParams.get("ns") || "default";

  if (!pod) {
    ws.send("Missing ?pod=name");
    ws.close();
    return;
  }

  console.log(`ğŸ”— Nueva sesiÃ³n bash interactiva en pod ${namespace}/${pod}`);

  // Streams que conectaremos al WS
  const stdoutStream = new stream.PassThrough();
  const stderrStream = new stream.PassThrough();
  const stdinStream = new stream.PassThrough();

  // Enviamos todo lo que el pod escriba al cliente WebSocket
  stdoutStream.on("data", (chunk) => ws.send(chunk));
  stderrStream.on("data", (chunk) => ws.send(chunk));

  // Lo que el usuario teclee â†’ stdin del proceso remoto
  ws.on("message", (msg) => {
    stdinStream.write(msg);
  });

  // Cerramos todo cuando el WS se cierre
  ws.on("close", () => {
    stdinStream.end();
    stdoutStream.end();
    stderrStream.end();
  });

  // Lanza bash en modo interactivo (TTY = true)
  exec.exec(
    namespace,
    pod,
    "", // container name opcional
    ["bash"],
    stdoutStream,
    stderrStream,
    stdinStream,
    true, // tty habilitado
    (status) => {
      console.log("ğŸ’¤ SesiÃ³n cerrada", status);
      ws.close();
    }
  );
});

server.listen(3001, () => {
  console.log("ğŸš€ Shell server listo en puerto 3001");
});
